<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gas Price Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #1e1e1e;
      color: #d4d4d4;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    canvas {
      background-color: #2d2d2d;
      border: 1px solid #444;
      margin-bottom: 20px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .controls button {
      background-color: #444;
      color: #d4d4d4;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .controls button:hover {
      background-color: #555;
    }

    .controls button.active {
      background-color: #007acc;
      color: white;
    }

    .toggle-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Gas Price Tracker</h1>
  <div class="controls">
    <button id="oneHour">1 Hour</button>
    <button id="oneDay">1 Day</button>
    <button id="sevenDays" class="active">7 Days</button>
    <button id="thirtyDays">30 Days</button>
    <button id="pauseUpdates">Pause Updates</button>
  </div>

  <div class="toggle-controls">
    <button id="togglePredicted">Toggle Predicted</button>
    <button id="toggleActual">Toggle Actual</button>
  </div>

  <canvas id="gasPriceChart" width="800" height="400"></canvas>

  <script>
    const oneHourButton = document.getElementById("oneHour");
    const oneDayButton = document.getElementById("oneDay");
    const sevenDaysButton = document.getElementById("sevenDays");
    const thirtyDaysButton = document.getElementById("thirtyDays");
    const pauseUpdatesButton = document.getElementById("pauseUpdates");
    const togglePredictedButton = document.getElementById("togglePredicted");
    const toggleActualButton = document.getElementById("toggleActual");

    const buttons = [oneHourButton, oneDayButton, sevenDaysButton, thirtyDaysButton];
    let isPaused = false;
    let currentRange = "7d";

    // Highlight active button
    const setActiveButton = (button) => {
      buttons.forEach((btn) => btn.classList.remove("active"));
      button.classList.add("active");
    };

    // Range filter button events
    oneHourButton.addEventListener("click", () => {
      setActiveButton(oneHourButton);
      currentRange = "1h";
      fetchData();
    });
    oneDayButton.addEventListener("click", () => {
      setActiveButton(oneDayButton);
      currentRange = "1d";
      fetchData();
    });
    sevenDaysButton.addEventListener("click", () => {
      setActiveButton(sevenDaysButton);
      currentRange = "7d";
      fetchData();
    });
    thirtyDaysButton.addEventListener("click", () => {
      setActiveButton(thirtyDaysButton);
      currentRange = "30d";
      fetchData();
    });

    pauseUpdatesButton.addEventListener("click", () => {
      isPaused = !isPaused;
      pauseUpdatesButton.textContent = isPaused ? "Resume Updates" : "Pause Updates";
    });

    // Initialize the chart
    const ctx = document.getElementById("gasPriceChart").getContext("2d");
    const chart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      {
        label: "Predicted Gas Price",
        data: [],
        borderColor: "#4caf50",
        borderWidth: 2,
        pointRadius: 4,
        fill: false,
        yAxisID: "yLog",
        showLine: true,
        spanGaps: true,
      },
      {
        label: "Actual Gas Price",
        data: [],
        borderColor: "#e91e63",
        borderDash: [5, 5],
        borderWidth: 2,
        pointRadius: 4,
        fill: false,
        yAxisID: "yLinear",
      },
    ],
  },
  options: {
    responsive: true,
    animation: {
      duration: 500, // Smooth transition duration
      easing: "easeInOutQuad", // Easing style for transitions
    },
    plugins: {
      legend: {
        labels: { color: "#d4d4d4" },
      },
      tooltip: {
        callbacks: {
          title: (tooltipItems) => tooltipItems[0].label,
          label: (tooltipItem) => {
            const datasetLabel = tooltipItem.dataset.label || "";
            const value = tooltipItem.raw || 0;
            return `${datasetLabel}: ${value.toFixed(2)} Gwei`;
          },
        },
      },
    },
    scales: {
      x: {
        title: {
          display: true,
          text: "Block Details (Height & Time)",
          color: "#d4d4d4",
        },
        ticks: { color: "#d4d4d4" },
      },
      yLinear: {
        type: "linear",
        display: true,
        position: "left",
        title: {
          display: true,
          text: "Gas Price (Gwei) - Linear",
          color: "#d4d4d4",
        },
        ticks: { color: "#d4d4d4" },
      },
      yLog: {
        type: "logarithmic",
        display: true,
        position: "right",
        title: {
          display: true,
          text: "Gas Price (Gwei) - Log",
          color: "#d4d4d4",
        },
        min: 0.5,
        max: 2,
        ticks: {
          color: "#d4d4d4",
          callback: function (value) {
            return Number(value).toLocaleString();
          },
        },
      },
    },
  },
});

    // Toggle line events
    togglePredictedButton.addEventListener("click", () => {
      const predictedDataset = chart.data.datasets[0];
      predictedDataset.hidden = !predictedDataset.hidden;
      chart.update();
    });
    toggleActualButton.addEventListener("click", () => {
      const actualDataset = chart.data.datasets[1];
      actualDataset.hidden = !actualDataset.hidden;
      chart.update();
    });

// Data fetch
const fetchData = async () => {
  if (isPaused) return;

  try {
    const response = await fetch(`/api/chart-data?range=${currentRange}`);
    const { seiData, evmData } = await response.json();

    // Ensure seiData and evmData are arrays
    const seiDataArray = Array.isArray(seiData) ? seiData : [];
    const evmDataArray = Array.isArray(evmData) ? evmData : [];

    // Determine max data points based on range
    const maxDataPoints = {
      "1h": 3600 / 3, // Assuming 3-second intervals
      "1d": 24 * 3600 / 3,
      "7d": 7 * 24 * 3600 / 3,
      "30d": 30 * 24 * 3600 / 3,
    }[currentRange];

    // Add new data and remove old data for smooth updates
    seiDataArray.forEach((d) => {
      const label = `Block: ${d.blockNumber}\n${new Date(d.timestamp).toLocaleTimeString()}`;
      const dataPoint = d.confidence99 || 0;

      if (chart.data.labels.length >= maxDataPoints) {
        chart.data.labels.shift(); // Remove oldest label
        chart.data.datasets[0].data.shift(); // Remove oldest predicted gas price
      }
      chart.data.labels.push(label); // Add new label
      chart.data.datasets[0].data.push(dataPoint); // Add new data point
    });

    evmDataArray.forEach((d) => {
      const dataPoint = d.confidence99 || 0;

      if (chart.data.datasets[1].data.length >= maxDataPoints) {
        chart.data.datasets[1].data.shift(); // Remove oldest actual gas price
      }
      chart.data.datasets[1].data.push(dataPoint); // Add new data point
    });

    chart.update(); // Update the chart without full rebuild
  } catch (error) {
    console.error("Error fetching chart data:", error);
  }
};

    setInterval(fetchData, 5000); // Refresh every 5 seconds
    fetchData(); // Initial load
  </script>
</body>
</html>
