<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gas Price Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #1e1e1e;
      color: #d4d4d4;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    canvas {
      background-color: #2d2d2d;
      border: 1px solid #444;
      margin-bottom: 20px;
      will-change: transform;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .controls button {
      background-color: #444;
      color: #d4d4d4;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .controls button:hover {
      background-color: #555;
    }

    .controls button.active {
      background-color: #007acc;
      color: white;
    }

    .toggle-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    /* Updated toggle button styles */
    .toggle-controls button {
      background-color: #007acc;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: background-color 0.3s, transform 0.3s;
    }

    .toggle-controls button:hover {
      background-color: #005ea8;
      transform: scale(1.05);
    }

    .toggle-controls button.active {
      background-color: #003f6b;
      color: #d4d4d4;
    }
  </style>
</head>
<body>
  <h1>Gas Price Tracker</h1>
  <div class="controls">
    <button id="oneHour" class="active">1 Hour</button>
    <button id="oneDay">1 Day</button>
    <button id="sevenDays">7 Days</button>
    <button id="thirtyDays">30 Days</button>
    <button id="pauseUpdates">Pause Updates</button>
  </div>

  <div class="toggle-controls">
    <button id="togglePredicted">Toggle Predicted</button>
    <button id="toggleActual">Toggle Actual</button>
  </div>

  <canvas id="gasPriceChart" width="800" height="400"></canvas>

  <script>
    const oneHourButton = document.getElementById("oneHour");
    const oneDayButton = document.getElementById("oneDay");
    const sevenDaysButton = document.getElementById("sevenDays");
    const thirtyDaysButton = document.getElementById("thirtyDays");
    const pauseUpdatesButton = document.getElementById("pauseUpdates");
    const togglePredictedButton = document.getElementById("togglePredicted");
    const toggleActualButton = document.getElementById("toggleActual");

    const buttons = [oneHourButton, oneDayButton, sevenDaysButton, thirtyDaysButton];
    let isPaused = false;
    let currentRange = "1h"; // Default to 1 Hour

    // Highlight active button
    const setActiveButton = (button) => {
      buttons.forEach((btn) => btn.classList.remove("active"));
      button.classList.add("active");
    };

    // Range filter button events
    oneHourButton.addEventListener("click", () => {
      setActiveButton(oneHourButton);
      currentRange = "1h";
      fetchData();
    });
    oneDayButton.addEventListener("click", () => {
      setActiveButton(oneDayButton);
      currentRange = "1d";
      fetchData();
    });
    sevenDaysButton.addEventListener("click", () => {
      setActiveButton(sevenDaysButton);
      currentRange = "7d";
      fetchData();
    });
    thirtyDaysButton.addEventListener("click", () => {
      setActiveButton(thirtyDaysButton);
      currentRange = "30d";
      fetchData();
    });

    pauseUpdatesButton.addEventListener("click", () => {
      isPaused = !isPaused;
      pauseUpdatesButton.textContent = isPaused ? "Resume Updates" : "Pause Updates";
    });

    // Initialize the chart
    const ctx = document.getElementById("gasPriceChart").getContext("2d");
    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Predicted Gas Price",
            data: [],
            borderColor: "#4caf50",
            borderWidth: 2,
            pointRadius: 4,
            fill: false,
            yAxisID: "yLog",
            showLine: true,
            spanGaps: true,
          },
          {
            label: "Actual Gas Price",
            data: [],
            borderColor: "#e91e63",
            borderDash: [5, 5],
            borderWidth: 2,
            pointRadius: 4,
            fill: false,
            yAxisID: "yLinear",
          },
        ],
      },
      options: {
        responsive: true,
        animation: {
          duration: 500, // Smooth transition duration
          easing: "easeInOutQuad", // Easing style for transitions
        },
        plugins: {
          legend: {
            labels: { color: "#d4d4d4" },
          },
          tooltip: {
            callbacks: {
              title: (tooltipItems) => tooltipItems[0].label,
              label: (tooltipItem) => {
                const datasetLabel = tooltipItem.dataset.label || "";
                const value = tooltipItem.raw || 0;
                return `${datasetLabel}: ${value.toFixed(2)} Gwei`;
              },
            },
          },
        },
        scales: {
          x: {
            title: {
              display: true,
              text: "Block Details (Height & Time)",
              color: "#d4d4d4",
            },
            ticks: { color: "#d4d4d4" },
          },
          yLinear: {
            type: "linear",
            display: true,
            position: "left",
            title: {
              display: true,
              text: "Gas Price (Gwei) - Linear",
              color: "#d4d4d4",
            },
            ticks: { color: "#d4d4d4" },
          },
          yLog: {
            type: "logarithmic",
            display: true,
            position: "right",
            title: {
              display: true,
              text: "Gas Price (Gwei) - Log",
              color: "#d4d4d4",
            },
            min: 0.5,
            max: 2,
            ticks: {
              color: "#d4d4d4",
              callback: function (value) {
                return Number(value).toLocaleString();
              },
            },
          },
        },
      },
    });

    // Toggle line events
    togglePredictedButton.addEventListener("click", () => {
      const predictedDataset = chart.data.datasets[0];
      predictedDataset.hidden = !predictedDataset.hidden;
      togglePredictedButton.classList.toggle("active", !predictedDataset.hidden);
      chart.update();
    });

    toggleActualButton.addEventListener("click", () => {
      const actualDataset = chart.data.datasets[1];
      actualDataset.hidden = !actualDataset.hidden;
      toggleActualButton.classList.toggle("active", !actualDataset.hidden);
      chart.update();
    });

    // Fetch data function
    const fetchData = async () => {
  if (isPaused) return;

  try {
    const response = await fetch(`/api/chart-data?range=${currentRange}`);
    const { seiData, evmData } = await response.json();

    const seiDataArray = Array.isArray(seiData) ? seiData : [];
    const evmDataArray = Array.isArray(evmData) ? evmData : [];

    const nowUTC = Date.now();
    let timeFilter, maxDataPoints;

    switch (currentRange) {
      case "1h":
        timeFilter = nowUTC - 60 * 60 * 1000;
        maxDataPoints = Math.floor(3600 / 0.4); // ~400ms intervals
        break;
      case "1d":
        timeFilter = nowUTC - 24 * 60 * 60 * 1000;
        maxDataPoints = Math.floor(24 * 3600 / 0.4);
        break;
      case "7d":
        timeFilter = nowUTC - 7 * 24 * 60 * 60 * 1000;
        maxDataPoints = Math.floor(7 * 24 * 3600 / 0.4);
        break;
      case "30d":
        timeFilter = nowUTC - 30 * 24 * 60 * 60 * 1000;
        maxDataPoints = Math.floor(30 * 24 * 3600 / 0.4);
        break;
      default:
        timeFilter = nowUTC - 60 * 60 * 1000;
        maxDataPoints = Math.floor(3600 / 0.4);
    }

    const filteredSeiData = seiDataArray.filter(
      (d) => new Date(d.timestamp).getTime() >= timeFilter
    );
    const filteredEvmData = evmDataArray.filter(
      (d) => new Date(d.timestamp).getTime() >= timeFilter
    );

    // Prepare new data
    const newLabels = [];
    const newPredictedData = [];
    const newActualData = [];

    filteredSeiData.forEach((point, index) => {
      const label = `Block: ${point.blockNumber}\n${new Date(
        point.timestamp
      ).toLocaleTimeString()}`;
      newLabels.push(label);
      newPredictedData.push(point.confidence99 || 0);
      newActualData.push(filteredEvmData[index]?.confidence99 || 0);
    });

    // Use only the latest data up to maxDataPoints
    chart.data.labels = newLabels.slice(-maxDataPoints);
    chart.data.datasets[0].data = newPredictedData.slice(-maxDataPoints);
    chart.data.datasets[1].data = newActualData.slice(-maxDataPoints);

    chart.update("none");
  } catch (error) {
    console.error("Error fetching chart data:", error);
  }
};

window.onload = () => {
  setActiveButton(oneHourButton);
  fetchData(); // Fetch data for default range
};

setInterval(fetchData, 5000); // Refresh every 5 seconds

  </script>
</body>
</html>
